---
title: "BomMavProj"
author: "Go Mavankal"
date: "February 19, 2018"
output: html_document
v2
---

## MSDS 8390 PROJECT 1 - A - Change points represent structural changes, remove before modeling
##  AAPL stock modeling
Team Members
.	Gopinath Mavankal
.	Chris Boomhower
Project Overview
How do predictions of stock price based on ARIMA models compare with those based on multiple linear regression / machine learning based models of social media data. 


```{r, include=FALSE}
#Release memory to load big data sets...
rm(list = ls())
gc()
par(mfrow=c(1,1))

##  options(repos = c(CRAN = "https://cran.rstudio.com"))
```

## The data is in a csv file that has all stocks in the portfolio listed as columns
## source of this data:  
## The range for each stock is Daily periodicity from 1990-03-05 to 2018-03-02 for both highs and lows
## Only the highs would be used.  The lows would not be used here, but was downloaded in case the portfolio management strategy were to be deployed, which is to buy one stock at a low and sell another at its high.

Load and analyze the stocks in the portfolio:

```{r }
#?zoo
install.packages("xts")
library(xts)
require("xts")

###  library("forecast") ####  could not be loaded because of older xts but newer could not be located
###   https://github.com/joshuaulrich/xts/issues/163  documents this bug
###

## data file has data on all daily highs for 11 stocks
Portfoliohi <- read.zoo("D:/03-Repos/RStudio/SpecialTopicsSpring2018/Project/StockPrices/DailyHi.csv",header = TRUE,sep=",",  format = "%m/%d/%Y")
head(Portfoliohi)
NROW(Portfoliohi)
plot.zoo(Portfoliohi)
colnames(Portfoliohi)
str(Portfoliohi)
class(Portfoliohi)
summary(Portfoliohi)

?zoo
which(format(index(Portfoliohi), "%Y-%m-%d") == '2017-02-09')
tail(Portfoliohi)    

## create a xts and matrix objects from the zoo object
Portfoliohix <- as.xts(Portfoliohi)
Portfoliohim <- as.matrix(Portfoliohix)
head.matrix(Portfoliohim)
## Count the years in the data
nyears(Portfoliohim)
## Count the months
nmonths(Portfoliohim)
## Count the number of quarters
nquarters(Portfoliohim)
## what is the periodicity in the data using an xts function
periodicity(Portfoliohix)
## Locate enoints by time as months years and quarters
epw <- endpoints(Portfoliohix, k=1)
epm <- endpoints(Portfoliohix,on="months")
epy <- endpoints(Portfoliohix,on="years")
epq <- endpoints(Portfoliohix, on="quarters")
## Split by year (puts a segment number between years) to use in computing stats by year
Portfolio_yearly <- split.xts(Portfoliohix, f="years")

```

## Analyze one stock for structural changes or shifts as changepoints
## Method:  AMOC with MBIC
   1.  detect a change point using change in both mean and variance for the entire data set.
   2.  create a new data set using this change point and repeat till the parameters converge
   3.  Method chosen is cpt.meanvar - which Identifies Changes in Mean and Variance
   4.  cpt.meanvar default settings use AMOC (At most one change) method, with a penalty of MBIC (Modified Bayes Information Criterion), to locate a single changepoint
   5.  Changepoint package is different from previous packages in that it provides several  a choice of search algorithms for multiple changepoint detection in addition to a variety of test statistics. 


```{r}
library(data.table)
library(changepoint)

# matrix of just the AMZN stocks
#AMZN_m <- Portfoliohim[,c(2) ]
#AMZN <- Portfoliohi[,c(2) ]
#AMZN_x <- Portfoliohix[,c(2)]

# matrix of just the AMZN stocks
#AAPL_m <- Portfoliohim[,c(1) ]
AAPL <- Portfoliohi[,c(1) ]
#AAPL_x <- Portfoliohix[,c(1)]

head(AAPL)
tail(AAPL)
#head(AAPL_m)
#head(AAPL_x)
## the xts format is different from the other two above

## Is there a breakpoint and how many are there in the stock history
# remove the NA values as they cause an issue with this package
# Use the changepoint library to find the range of dates to use in the model
library(changepoint)
AAPL[is.na(AAPL)] <- 0
unique(is.na(AAPL))

### locate the breakpoints till they converge to determine which set of data to model with
aapl_cptmv <- cpt.meanvar(AAPL)
plot(aapl_cptmv)
print(aapl_cptmv)
NROW(AAPL)
# from above outputs, obtained the change point and the total (end of the list)
AAPL_1 <- AAPL[3714:7055,]
head(AAPL_1)
tail(AAPL_1)
# the breakpoint detected using a change in both mean and variance begins from 22 Nov 2004
# let us use this subset to find if there is another breakpoint in the data

aapl_cptmv1 <- cpt.meanvar(AAPL_1)
plot(aapl_cptmv1)
print(aapl_cptmv1)

# get the end point for the new set
NROW(AAPL_1)
AAPL_2 <- AAPL_1[1467:3342,]
head(AAPL_2)
tail(AAPL_2)
# the breakpoint detected using a change in both mean and variance begins from 20 Sep 2010
# let us use this subset to find if there is another breakpoint in the data till recent

aapl_cptmv2 <- cpt.meanvar(AAPL_2)
plot(aapl_cptmv2)
print(aapl_cptmv2)

NROW(AAPL_2)
AAPL_3 <- AAPL_2[907:1876,]
head(AAPL_3)
tail(AAPL_3)
NROW(AAPL_3)
# the breakpoint detected using a change in both mean and variance begins from 28 April 2014
# let us use this subset to find if there is another breakpoint in the data till recent

aapl_cptmv3 <- cpt.meanvar(AAPL_3)
plot(aapl_cptmv3)
print(aapl_cptmv3)

AAPL_4 <- AAPL_3[704:970,]
head(AAPL_4)
tail(AAPL_4)
NROW(AAPL_4)
# the breakpoint detected using a change in both mean and variance begins from 9 Feb 2017
# let us use this subset to find if there is another breakpoint in the data till recent

aapl_cptmv4 <- cpt.meanvar(AAPL_4)
plot(aapl_cptmv4)
print(aapl_cptmv4)


AAPL_5 <- AAPL_4[183:267,]
head(AAPL_5)
tail(AAPL_5)
NROW(AAPL_5)
# the breakpoint detected using a change in both mean and variance begins from 30 Oct 2017
# let us use this subset to find if there is another breakpoint in the data till recent

aapl_cptmv5 <- cpt.meanvar(AAPL_5)
plot(aapl_cptmv5)
print(aapl_cptmv5)
#  the breakpoints as seen in the plot are now close to each other, so they have converged
#  There fore do ARIMA with AAPL_4 data set because AAPL_5 does not have a changepoint

## determine the number of changepoints using methods that detect multiple points
aapl.binseg=cpt.meanvar(AAPL,test.stat='Exponential',method='BinSeg',Q=20,penalty="SIC")
cpts(aapl.binseg)
param.est(aapl.binseg)
plot(aapl.binseg,cpt.width=3,cpt.col='blue')

##  Compare the breakpoint we located one by one versus that located by the binseg procedure
which(format(index(Portfoliohi), "%Y-%m-%d") == '2017-02-09')
tail(Portfoliohi) 

###  CONCLUSION  ---  multiple breakpoints located 6785 as the last breakpoint and 6085 as the one prior to that.
### CONCLUSION   ---  One at a time detection of the segments produced 6789 as the breakpoint to use for modelling as the breakpoint detected thereafter converged.
###   ADVISE from CONCLUSION - use the last breakpoint from the multiple detection.

aapl.crops=cpt.meanvar(AAPL,method="PELT",penalty="CROPS",pen.value=c(5,500))
plot(aapl.crops,ncpts=1000)
plot(aapl.crops,diagnostic=TRUE)
# detecting multiple changepoints in one test does not appear to have improved the single changepoint detection at a time

```

## Find the chang point for AMZN
#

```{r}
# matrix of just the AMZN stocks
#AMZN_m <- Portfoliohim[,c(2) ]
AMZN <- Portfoliohi[,c(2) ]
#AMZN_x <- Portfoliohix[,c(2)]


head(AMZN)
tail(AMZN)
#head(AMZN_m)
#head(AMZN_x)
## the xts format is different from the other two above

## Is there a breakpoint and how many are there in the stock history
# remove the NA values as they cause an issue with this package
# Use the changepoint library to find the range of dates to use in the model
library(changepoint)
AMZN[is.na(AMZN)] <- 0
unique(is.na(AMZN))

### locate the breakpoints till they converge to determine which set of data to model with
AMZN_cptmv <- cpt.meanvar(AMZN)
plot(AMZN_cptmv)
print(AMZN_cptmv)
NROW(AMZN)
# from above outputs, obtained the change point and the total (end of the list)
AMZN_1 <- AMZN[1822:7055,]
head(AMZN_1)
tail(AMZN_1)
# the breakpoint detected using a change in both mean and variance begins from 15 May 1997
# let us use this subset to find if there is another breakpoint in the data

AMZN_cptmv1 <- cpt.meanvar(AMZN_1)
plot(AMZN_cptmv1)
print(AMZN_cptmv1)

# get the end point for the new set
NROW(AMZN_1)
AMZN_2 <- AMZN_1[3131:5234,]
head(AMZN_2)
tail(AMZN_2)
# the breakpoint detected using a change in both mean and variance begins from 22 Oct 2009
# let us use this subset to find if there is another breakpoint in the data till recent

AMZN_cptmv2 <- cpt.meanvar(AMZN_2)
plot(AMZN_cptmv2)
print(AMZN_cptmv2)

NROW(AMZN_2)
AMZN_3 <- AMZN_2[1384:2104,]
head(AMZN_3)
tail(AMZN_3)
NROW(AMZN_3)
# the breakpoint detected using a change in both mean and variance begins from 23 April 2015
# let us use this subset to find if there is another breakpoint in the data till recent

AMZN_cptmv3 <- cpt.meanvar(AMZN_3)
plot(AMZN_cptmv3)
print(AMZN_cptmv3)

AMZN_4 <- AMZN_3[303:721,]
head(AMZN_4)
tail(AMZN_4)
NROW(AMZN_4)
# the breakpoint detected using a change in both mean and variance begins from 5 July 2016
# let us use this subset to find if there is another breakpoint in the data till recent

AMZN_cptmv4 <- cpt.meanvar(AMZN_4)
plot(AMZN_cptmv4)
print(AMZN_cptmv4)


AMZN_5 <- AMZN_4[187:419,]
head(AMZN_5)
tail(AMZN_5)
NROW(AMZN_5)
# the breakpoint detected using a change in both mean and variance begins from 30 Mar 2017
# let us use this subset to find if there is another breakpoint in the data till recent

AMZN_cptmv5 <- cpt.meanvar(AMZN_5)
plot(AMZN_cptmv5)
print(AMZN_cptmv5)

AMZN_6 <- AMZN_5[147:233,]
head(AMZN_6)
tail(AMZN_6)
NROW(AMZN_6)

# the breakpoint detected using a change in both mean and variance begins from 26 Oct 2017
# let us use this subset to find if there is another breakpoint in the data till recent
AMZN_cptmv6 <- cpt.meanvar(AMZN_6)
plot(AMZN_cptmv6)
print(AMZN_cptmv6)

AMZN_7 <- AMZN_6[52:87,]
head(AMZN_7)
tail(AMZN_7)
NROW(AMZN_7)

AMZN_cptmv7 <- cpt.meanvar(AMZN_7)
plot(AMZN_cptmv7)
print(AMZN_cptmv7)

AMZN_8 <- AMZN_7[11:36,]
head(AMZN_8)
tail(AMZN_8)
NROW(AMZN_8)

# the breakpoint detected using a change in both mean and variance begins from 25 Jan 2018
# let us use this subset to find if there is another breakpoint in the data till recent

AMZN_cptmv8 <- cpt.meanvar(AMZN_8)
plot(AMZN_cptmv8)
print(AMZN_cptmv8)
#  the breakpoints as seen in the plot are now close to each other, so they have converged
#  There fore do ARIMA with AMZN_4 data set because AMZN_5 does not have a changepoint

## determine the number of changepoints using methods that detect multiple points
AMZN.binseg=cpt.meanvar(AMZN,test.stat='Exponential',method='BinSeg',Q=20,penalty="SIC")
cpts(AMZN.binseg)
param.est(AMZN.binseg)
plot(AMZN.binseg,cpt.width=3,cpt.col='blue')

AMZN.crops=cpt.meanvar(AMZN,method="PELT",penalty="CROPS",pen.value=c(5,500))
#plot(AMZN.crops,ncpts=1000)  ## Your input object doesn't have a segmentation with the requested number of changepoints.
plot(AMZN.crops,diagnostic=TRUE)
# detecting multiple changepoints in one test does not appear to have improved the single changepoint detection at a time
```

```{r}
#install.packages("xts", repos = "https://cloud.r-project.org/", dependencies = TRUE)
library(forecast)
?auto.arima
# obtain the subset of data from Feb 9 2017 to current for modelling
# Find the begin and end of AAPL4 using the dates 
which(format(index(Portfoliohi), "%Y-%m-%d") == '2017-02-09')
tail(Portfoliohi) 
which(format(index(Portfoliohi), "%Y-%m-%d") == '2018-03-02')
## Rebuild the time series object to use in the modeling using the information from above
AAPL_tomodel <- Portfoliohi[6787:7055,c(1) ]

AAPL_ret <- diff(AAPL / lag(AAPL, k = -1) * 100)
AAPL_ret_l <- diff(log10(AAPL) / lag(log10(AAPL), k = -1) * 100)
AAPL4_ret <- diff(AAPL_tomodel / lag(AAPL_tomodel, k = -1) * 100)


head(AAPL_ret)
head(AAPL4_ret)
tail(AAPL4_ret)

plot(diff(AAPL),ylab='Differenced AAPL Daily Highs from 9 Feb 2017 ')
plot(diff(log10(AAPL)),ylab='Differenced LOG10 AAPL Daily Highs from 9 Feb 2017 ')
plot(diff(AAPL_tomodel),ylab='Differenced AAPL Daily Highs from 9 Feb 2017 ')

# use untransformed all data

aapl_all_mod <- auto.arima(AAPL_ret,stationary = TRUE, seasonal = FALSE, ic="aic",test="kpss")
summary(aapl_all_mod)
plot(forecast.Arima(aapl_all_mod), ylab="all-aic-kpss")

## Use Log10 all data

aapl_all_log_mod <- auto.arima(AAPL_ret_l,stationary = TRUE, seasonal = FALSE, ic="aic",test="kpss")
summary(aapl_all_log_mod)
plot(forecast.Arima(aapl_all_log_mod), ylab="all-log10-aic-kpss")

#  Recent data set without change point or Structural Change 

AAPL_no_chgpt <- auto.arima(AAPL4_ret,stationary = TRUE, seasonal = FALSE, ic="aic",test="kpss")
summary(AAPL_no_chgpt)
plot(forecast.Arima(AAPL_no_chgpt), ylab="noChgPts-aic-kpss")


```

Note that there was an issue with package install of forecast.  This site accessed on 4 Mar 2018 provided an explanation and a fix
https://social.technet.microsoft.com/Forums/en-US/d18e1d09-bd3c-495c-987c-5478aef44210/vs-is-not-showing-the-latest-package-version-as-available-on-cran-xts-0100?forum=ropen

The fix


```{r}
#install.packages("xts", repos = "https://cloud.r-project.org/", dependencies = TRUE)
library(forecast)
AAPLhi_ret <- diff(AAPL) / lag(AAPL, k = -1) * 100
plot(diff(AAPL),ylab='Differenced AAPL Daily Highs Stock')
##  since the variance is increasing with time, do a log transform
plot(log10(AAPL),ylab='Log (AAPL stock hi (daily))')
## there is an upward trend in the mean, so detrend it
plot(diff(log10(AAPL)),ylab='Differenced Log (AAPL Daily High Stock)')
#  Produce ACF and PACF plots

par(mfrow = c(1,2))
Acf(diff(log10(AAPL)), main=" ACF Plot for Log10 AAPL DlyHi")
Pacf(diff(log10(AAPL)), main= "ACF Plot for Log10 AAPL DlyHi")

## all the above steps are done automatially in auto.arima

mod1 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE, ic="aic")
summary(mod1)
#plot(forecast(mod1,h=20)) #ERROR Error in forecast(mod1, h = 20) : unused argument (h = 20)

mod2 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE, ic="aicc")
plot(forecast(mod2,h=20))

mod3 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE, ic="bic")
plot(forecast(mod3,h=20))

mod5 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE,allowdrift=TRUE,allowmean=TRUE, ic="bic")
plot(forecast(mod5,h=20))
pd1 <- predict(mod1,n.ahead = 6, newxreg = NULL, se.fit = TRUE)
head(mod5)

??auto.arima
par(mfrow = c(1,1))
pred1 = predict(mod1, n.ahead = 20)
pred1
plot(AAPL,type='l',xlim=c(2012,2019),ylim=c(1,250),xlab = 'Year',ylab = 'LOG 10 AAPL Daily High Stock price')
lines(10^(pred1$pred),col='blue')
lines(10^(pred1$pred+2*pred1$se),col='orange')
lines(10^(pred1$pred-2*pred1$se),col='orange')

```


```{r}
#install.packages("aTSA")
library(aTSA)
AAPL_ret <- diff(AAPL_tomodel / lag(AAPL_tomodel, k = -1) * 100)

# Defining variables
Y <- AAPL_ret
d.Y <- diff(Y)
t <- AAPL_ret[1:269,0]
head(AAPL_tomodel)
str(AAPL_tomodel)

# Descriptive statistics and plotting the data
summary(Y)
summary(d.Y)

#plot(t,Y) #  ERROR - series cannot be merged with non-unique index entries in a series
plot(d.Y)

#multiplots with Auto-Title
data(AAPL_tomodel)
library(sfsmisc)
# time is the index, p.ts will plot all the columns in the data
p.ts(AAPL_tomodel,nr=1,main.tit = "AAPL daily close")

# identifying changes in mean using changepoint library uses numerical data only, did not work for this set

#Test for stationarity
# Dickey-Fuller test for variable
adf.test(Y,alternative="stationary", k=0) # function not found, fix the data type


# Augmented Dickey-Fuller test - test for stationarity (Non-Seasonal)
adf.test(Y, alternative="stationary")

# DF and ADF tests for differenced variable
adf.test(d.Y, k=0)
adf.test(d.Y)

# ACF and PACF
acf(Y)
pacf(Y)

acf(d.Y)
pacf(d.Y)

#Let the computer do the work...
library("forecast")

BestModelDiff <- auto.arima(d.Y, stationary = TRUE, seasonal = FALSE, ic="aic")
BestModelDiff

??autoarima

#Versus the original - must set stationary to TRUE IN THIS MODEL.  Note the results compared to the differenced model...
BestModel_aic <- auto.arima(Y, stationary = TRUE, seasonal = FALSE, ic="aic")
BestModel_aicc <-auto.arima(Y, stationary = TRUE, seasonal = FALSE, ic="aicc")
BestModel_bic <-auto.arima(Y, stationary = TRUE, seasonal = FALSE, ic="bic")

#********************
#Confirm by testing....
# ARIMA(1,1,0) or AR(1)
#arima(Y, order = c(1,1,0))

# ARIMA(1,0,0) or AR(1)
arima(d.Y, order = c(1,0,0))

confint(BestModel_aic)
tsdiag(BestModel_aic)

confint(BestModel_aicc)
tsdiag(BestModel_aicc)

confint(BestModel_bic)
tsdiag(BestModel_bic)

## Plot Actual Data vs Fitted Data using aic
plot(BestModel_aic$x, lty = 1, main = "UKHP prices returns: raw data vs. (aic)fitted values", ylab = "Return in percent", xlab = "Date")
lines(fitted(BestModel_aic), lty = 2,lwd = 2, col = "red")

## Plot Actual Data vs Fitted Data using aicc 
plot(BestModel_aicc$x, lty = 1, main = "UKHP prices returns: raw data vs. (aicc)fitted values", ylab = "Return in percent", xlab = "Date")
lines(fitted(BestModel_aicc), lty = 2,lwd = 2, col = "red")

## Plot Actual Data vs Fitted Data using bic
plot(BestModel_bic$x, lty = 1, main = "UKHP prices returns: raw data vs. (bic)fitted values", ylab = "Return in percent", xlab = "Date")
lines(fitted(BestModel_bic), lty = 2,lwd = 2, col = "red")

## OBSERVATION of output - bic fitting picked up a little more of the structure than aic or aicc
?accuracy
## Review Accuracy Statisitcs of Model using the default in-sample (training set) accuracy measures
accuracy(BestModel_aic)
accuracy(BestModel_aicc)
accuracy(BestModel_bic)




#*****************
# Forecasting Example - Predict Into Future
#*****************
#aic model
predict(BestModel_aic, n.ahead=3)

plot(forecast(BestModel_aic))
#aicc model
predict(BestModel_aic, n.ahead=3)

plot(forecast(BestModel_aic))
#bic model
predict(BestModel_bic, n.ahead=3)

plot(forecast(BestModel_bic))



```




