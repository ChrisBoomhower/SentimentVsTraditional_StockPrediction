---
title: "BomMavProj"
author: "Go Mavankal"
date: "February 19, 2018"
output: html_document
---

```{r setup, include=TRUE}
knitr::opts_chunk$set(echo = TRUE)
```

## MSDS 8390 PROJECT 1

Team Members
.	Gopinath Mavankal
.	Chris Boomhower
Project Overview
How do predictions of stock price based on ARIMA models compare with those based on multiple linear regression / machine learning based models of social media data. 


```{r, include=FALSE}
#Release memory to load big data sets...
rm(list = ls())
gc()
par(mfrow=c(1,1))

options(repos = c(CRAN = "https://cran.rstudio.com"))
```

## Including Plots

You can also embed plots, for example:

```{r }
?zoo
library(xts)
require("xts")

###  library("forecast") ####  could not be loaded because of older xts but newer could not be located
###   https://github.com/joshuaulrich/xts/issues/163  documents this bug
###

## data file has data on all daily highs for 11 stocks
Portfoliohi <- read.zoo("D:/03-Repos/RStudio/SpecialTopicsSpring2018/Project/StockPrices/DailyHi.csv",header = TRUE,sep=",",  format = "%m/%d/%Y")
head(Portfoliohi)
NROW(Portfoliohi)
plot.zoo(Portfoliohi)
colnames(Portfoliohi)
str(Portfoliohi)
class(Portfoliohi)
summary(Portfoliohi)



## create a xts and matrix objects from the zoo object
Portfoliohix <- as.xts(Portfoliohi)
Portfoliohim <- as.matrix(Portfoliohix)
head.matrix(Portfoliohim)
## Count the years in the data
nyears(Portfoliohim)
## Count the months
nmonths(Portfoliohim)
## Count the number of quarters
nquarters(Portfoliohim)
## what is the periodicity in the data using an xts function
periodicity(Portfoliohix)
## Locate enoints by time as months years and quarters
epw <- endpoints(Portfoliohix, k=1)
epm <- endpoints(Portfoliohix,on="months")
epy <- endpoints(Portfoliohix,on="years")
epq <- endpoints(Portfoliohix, on="quarters")
## Split by year (puts a segment number between years) to use in computing stats by year
Portfolio_yearly <- split.xts(Portfoliohix, f="years")
```

```{r, include=FALSE}

period.apply(Portfoliohix, INDEX = epy, FUN = mean)
period.apply(Portfoliohix, INDEX = epq, FUN = mean)
period.apply(Portfoliohix, INDEX = epw, FUN =  mean)
## Create a list of yearly means
lapply(epy, FUN = mean)
## find the last observation in each year (returned all december data)
do.call(rbind,  lapply(split(Portfoliohix,"years"), function(w) last(w,n="1 month"))) 
###### find the last observation in each year (returned all december data)  USEFUL DATA summary
do.call(rbind,  lapply(split(Portfoliohix,"years"), function(w) last(w,n="1 week"))) 
## Apply standard deviation to rolling margins
rollapply(Portfoliohi, 3, sd)
```

```{r}

# Apply std deviation to just one stock in the portfolio
##  rollapply(PortfolioDF$AAPL,3,sd  )  output here has all stocks - not useful
## Pull one stock out of the portfolio to analyze

AAPLhi <- Portfoliohix[,"AAPL"]
NROW(AAPLhi)
head(AAPLhi)
plot(AAPLhi, main="AAPL weekly hi ")
# Plot shows no missing values - can we say that?
AAPLhi[which.max(AAPLhi)]
## stock splits are not accounted for - these will impact portfolio values

ret_simple_AAPL <- diff(AAPLhi) / lag(AAPLhi, k = -1) * 100
ret_cont_AAPL <- diff(log(AAPLhi)) * 100
summary(coredata(ret_simple_AAPL))
ret_simple_AAPL[which.min(ret_simple_AAPL)]

hist(ret_simple_AAPL, breaks=100, main = "Histogram of Simple Returns for AAPL", xlab="%")

####  COULD not proceed using auto.arima as a bug prevents loading the forecast package see link at top ##

AMZNhi <- Portfoliohix[,"AMZN"]
NROW(AMZNhi)
head(AMZNhi)
plot(AMZNhi, main="AMZN weekly hi ")


```

Note that there was an issue with package install of forecast.  This site accessed on 4 Mar 2018 provided an explanation and a fix
https://social.technet.microsoft.com/Forums/en-US/d18e1d09-bd3c-495c-987c-5478aef44210/vs-is-not-showing-the-latest-package-version-as-available-on-cran-xts-0100?forum=ropen

The fix


```{r}
install.packages("xts", repos = "https://cloud.r-project.org/", dependencies = TRUE)
library(forecast)
AAPLhi_ret <- diff(AAPLhi) / lag(AAPLhi, k = -1) * 100
plot(diff(AAPLhi),ylab='Differenced AAPL Daily Highs Stock')
##  since the variance is increasing with time, do a log transform
plot(log10(AAPLhi),ylab='Log (AAPL stock hi (daily))')
## there is an upward trend in the mean, so detrend it
plot(diff(log10(AAPLhi)),ylab='Differenced Log (AAPL Daily High Stock)')
#  Produce ACF and PACF plots

par(mfrow = c(1,2))
Acf(diff(log10(AAPLhi)), main=" ACF Plot for Log10 AAPL Daily Hi Stock Price")
Pacf(diff(log10(AAPLhi)), main= "ACF Plot for Log10 AAPL Daily Hi Stock Price")

## all the above steps are done automatially in auto.arima

mod1 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE, ic="aic")
summary(mod1)
plot(forecast(mod1,h=20))

mod2 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE, ic="aicc")
plot(forecast(mod2,h=20))

mod3 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE, ic="bic")
plot(forecast(mod3,h=20))

mod5 <- auto.arima(AAPLhi_ret, stationary = TRUE, seasonal = FALSE,allowdrift=TRUE,allowmean=TRUE, ic="bic")
plot(forecast(mod5,h=20))
pd1 <- predict(mod1,n.ahead = 6, newxreg = NULL, se.fit = TRUE)
head(mod5)

??auto.arima
par(mfrow = c(1,1))
pred1 = predict(mod1, n.ahead = 200)
pred1
plot(AAPLhi,type='l',xlim=c(2012,2019),ylim=c(1,250),xlab = 'Year',ylab = 'LOG 10 AAPL Daily High Stock price')
lines(10^(pred1$pred),col='blue')
lines(10^(pred1$pred+2*pred1$se),col='orange')
lines(10^(pred1$pred-2*pred1$se),col='orange')

```
